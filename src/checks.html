<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Model Pricing Checks</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#5D5CDE'
          }
        }
      }
    };
  </script>
  <style>
    :root,
    body,
    html {
      height: 100%;
    }

    @media (max-width: 1024px) {
      .table-container {
        overflow-x: auto;
      }
      table {
        min-width: 960px;
      }
    }

    .column-highlight {
      background-color: rgba(93, 92, 222, 0.08) !important;
    }

    .dark .column-highlight {
      background-color: rgba(93, 92, 222, 0.32) !important;
    }

    .column-highlight-header {
      color: #5D5CDE !important;
    }

    .dark .column-highlight-header {
      color: #8d8cff !important;
    }
  </style>
</head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 transition-colors min-h-screen">
  <div class="w-full mx-auto px-4 md:px-8 lg:px-12 py-8">
    <div class="mb-8">
      <h1 class="text-3xl md:text-4xl font-bold mb-2">Model Pricing Checks</h1>
      <p class="text-gray-600 dark:text-gray-400">Audit pricing consistency across providers and Poe overrides</p>
    </div>

    <div id="loadingState" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-300 border-t-primary"></div>
      <p class="mt-4 text-gray-600 dark:text-gray-400">Loading pricing checks...</p>
    </div>

    <div id="errorState" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6 text-center">
      <p class="text-red-800 dark:text-red-300" id="errorMessage"></p>
      <button
        onclick="loadChecks()"
        class="mt-4 px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-all"
      >
        Retry
      </button>
    </div>

    <div id="tableContainer" class="hidden space-y-4">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Pricing Detail by Provider</h2>
          <p id="timestamp" class="text-sm text-gray-500 dark:text-gray-400"></p>
        </div>
        <div class="table-container">
          <div class="overflow-x-auto">
            <table id="checks-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead class="bg-gray-50 dark:bg-gray-900"></thead>
              <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Respect system dark mode preference
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      document.documentElement.classList.toggle('dark', event.matches);
    });

    const BASE_COLUMNS = [
      { key: 'model', label: 'Model', rowSpan: 2 },
      { key: 'poe_prompt', label: 'Poe Prompt / MTok', rowSpan: 2, numeric: true },
      { key: 'poe_completion', label: 'Poe Completion / MTok', rowSpan: 2, numeric: true },
      { key: 'poe_input_cache_read', label: 'Poe Cache Read / MTok', rowSpan: 2, numeric: true },
      { key: 'poe_input_cache_write', label: 'Poe Cache Write / MTok', rowSpan: 2, numeric: true }
    ];

    const providerSeverityClasses = {
      yellow: ['bg-yellow-50', 'dark:bg-yellow-900/30'],
      red: ['bg-red-50', 'dark:bg-red-900/30'],
      muted: ['bg-gray-50', 'dark:bg-gray-900/30', 'text-gray-400', 'dark:text-gray-500']
    };

    const providerSelectedClasses = ['font-semibold', 'text-primary'];

    const BADGE_BASE_CLASS = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium';
    const BADGE_VARIANTS = {
      accepted: 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
      rejected: 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300',
      missing: 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300',
      key: 'bg-primary/10 text-primary',
      lookup: 'bg-primary/10 text-primary',
      auto: 'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300',
      reason: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-200',
      source: 'bg-primary text-white dark:bg-primary/90'
    };

    const BADGE_TITLES = {
      accepted: text => text ? `Accepted provider: ${text}` : 'Provider pricing accepted',
      rejected: () => 'Provider pricing rejected',
      missing: () => 'No pricing data returned by this provider',
      key: text => `Lookup key sent to provider: ${text}`,
      lookup: text => `Lookup key sent to provider: ${text}`,
      auto: () => 'Configured as auto in the mapping',
      reason: text => `Reason: ${text.replace(/_/g, ' ')}`,
      source: () => 'Using this provider as source of information'
    };

    function badgeClassName(variant) {
      const variantClass = BADGE_VARIANTS[variant] || 'bg-primary/10 text-primary';
      return `${BADGE_BASE_CLASS} ${variantClass}`;
    }

    function badgeTitle(variant, text) {
      const resolver = BADGE_TITLES[variant];
      if (!resolver) return null;
      try {
        return typeof resolver === 'function' ? resolver(text) : resolver;
      } catch {
        return null;
      }
    }

    function renderBadgeHtml(text, variant, titleOverride) {
      if (!text) return '';
      const titleText = titleOverride ?? badgeTitle(variant, text);
      const titleAttr = titleText ? ` title="${titleText}"` : '';
      return `<span class="${badgeClassName(variant)}"${titleAttr}>${text}</span>`;
    }

    function sanitizeValue(value) {
      if (value === null || value === undefined) return '—';
      if (typeof value === 'string' && (value.trim() === '' || value.trim().toLowerCase() === 'null')) return '—';
      return value;
    }

    function applyClasses(element, classes) {
      if (!classes) return;
      const list = Array.isArray(classes) ? classes : String(classes).split(/\s+/);
      list.filter(Boolean).forEach(cls => element.classList.add(cls));
    }

    function createBadge(text, variant) {
      const span = document.createElement('span');
      span.className = badgeClassName(variant);
      span.textContent = text;
      return span;
    }

    function createCell({ text = '—', html = null, numeric = false, classes = [] }) {
      const td = document.createElement('td');
      td.className = 'px-6 py-4 text-sm text-gray-700 dark:text-gray-200 align-top';
      if (numeric) td.classList.add('text-right', 'font-mono');
      applyClasses(td, classes);
      if (html) {
        td.innerHTML = html;
      } else {
        td.textContent = text ?? '—';
      }
      return td;
    }

    function buildHeaders(thead, providers) {
      thead.innerHTML = '';
      const primaryRow = document.createElement('tr');
      primaryRow.className = 'bg-gray-50 dark:bg-gray-900';
      const secondaryRow = document.createElement('tr');
      secondaryRow.className = 'bg-gray-100 dark:bg-gray-900/80';
      let columnIndex = 0;
      const providerColumnLookup = {};

      BASE_COLUMNS.forEach(column => {
        const th = document.createElement('th');
        th.className = 'px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-600 dark:text-gray-300';
        th.textContent = column.label;
        th.rowSpan = column.rowSpan || 1;
        if (column.numeric) th.classList.add('text-right');
        th.dataset.column = columnIndex;
        primaryRow.appendChild(th);
        columnIndex += 1;
      });

      providers.forEach(provider => {
        if (!provider.columns || provider.columns.length === 0) {
          return;
        }
        const th = document.createElement('th');
        th.textContent = provider.label || provider.name;
        th.colSpan = provider.columns.length;
        th.className = 'px-6 py-3 text-center text-xs font-semibold uppercase tracking-wide text-gray-600 dark:text-gray-300';
        th.dataset.providerGroup = provider.name;
        primaryRow.appendChild(th);

        provider.columns.forEach(column => {
          const subTh = document.createElement('th');
          subTh.textContent = column.label;
          subTh.className = 'px-4 py-2 text-left text-xs font-semibold text-gray-600 dark:text-gray-300';
          if (column.numeric) subTh.classList.add('text-right');
          subTh.dataset.column = columnIndex;
          subTh.dataset.provider = provider.name;
          secondaryRow.appendChild(subTh);
          if (!providerColumnLookup[provider.name]) {
            providerColumnLookup[provider.name] = [];
          }
          providerColumnLookup[provider.name].push(String(columnIndex));
          columnIndex += 1;
        });
      });

      thead.appendChild(primaryRow);
      if (secondaryRow.children.length) {
        thead.appendChild(secondaryRow);
      }
      return {
        totalColumns: columnIndex,
        providerColumnLookup
      };
    }

    function buildModelRow(model, providersMeta) {
      const row = document.createElement('tr');
      row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700/40 transition-colors';
      
      const modelStatuses = [];
      if (model.providers) {
        Object.values(model.providers).forEach(provider => {
          if (provider.status) {
            modelStatuses.push(provider.status.toLowerCase());
          }
        });
      }
      row.dataset.statuses = modelStatuses.join(',');
      
      const cells = [];
      const modelCell = document.createElement('td');
      modelCell.className = 'px-6 py-4 text-sm';
      const modelContent = document.createElement('div');
      modelContent.className = 'flex flex-wrap items-center gap-3';
      const link = document.createElement('a');
      link.href = `https://poe.com/${model.id}`;
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      link.textContent = model.id;
      link.className = 'font-medium text-primary hover:text-primary/80 hover:underline transition-colors';
      modelContent.appendChild(link);
      const ownerValue = sanitizeValue(model.owned_by);
      const ownerBadge = document.createElement('span');
      const ownerClasses =
        ownerValue === '—'
          ? 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300'
          : 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary/10 text-primary';
      ownerBadge.className = ownerClasses;
      ownerBadge.textContent = ownerValue;
      modelContent.appendChild(ownerBadge);
      modelCell.appendChild(modelContent);
      cells.push({ element: modelCell });

      const poePrompt = sanitizeValue(model.poe_pricing?.prompt_mtok);
      const poeCompletion = sanitizeValue(model.poe_pricing?.completion_mtok);
      const poeCacheRead = sanitizeValue(model.poe_pricing?.input_cache_read_mtok);
      const poeCacheWrite = sanitizeValue(model.poe_pricing?.input_cache_write_mtok);
      cells.push({ element: createCell({ text: poePrompt, numeric: true }) });
      cells.push({ element: createCell({ text: poeCompletion, numeric: true }) });
      cells.push({ element: createCell({ text: poeCacheRead, numeric: true }) });
      cells.push({ element: createCell({ text: poeCacheWrite, numeric: true }) });

      providersMeta.forEach(provider => {
        const columns = provider.columns || [];
        if (!columns.length) {
          return;
        }
        const providerData = model.providers?.[provider.name];
        columns.forEach(column => {
          const classes = ['bg-white', 'dark:bg-gray-800'];
          if (providerData) {
            if (providerData.severity && providerData.severity !== 'ok') {
              classes.push(...(providerSeverityClasses[providerData.severity] || []));
            }
            if (providerData.selected) {
              classes.push(...providerSelectedClasses);
            }
            const value = providerData.values?.[column.key];
            const lookup = providerData.lookup || {};
            let cellText = value?.text ?? '—';
            let cellHtml = value?.html ?? null;
            if (column.key === 'status') {
              const badges = [];
              const statusText = (value?.text || providerData.status || 'missing').toString();
              const statusVariant = statusText.toLowerCase();
              const acceptedTitle = providerData.selected && model.selected_provider
                ? `Accepted provider: ${model.selected_provider}`
                : undefined;
              badges.push(renderBadgeHtml(statusText, statusVariant, acceptedTitle));
              const requested = lookup.requested ?? null;
              const resolved = lookup.resolved ?? null;
              const reasons = Array.isArray(providerData.reasons) ? providerData.reasons : [];
              reasons
                .filter(Boolean)
                .forEach(reason => badges.push(renderBadgeHtml(reason, 'reason')));
              if (requested) {
                const variant = requested.toLowerCase() === 'auto' ? 'auto' : 'key';
                badges.push(renderBadgeHtml(requested, variant));
              }
              if (resolved && (!requested || resolved !== requested)) {
                badges.push(renderBadgeHtml(resolved, 'lookup'));
              }
              if (providerData.selected) {
                badges.push(renderBadgeHtml('source', 'source'));
              }
              if (badges.length) {
                cellHtml = `<div class="flex flex-wrap items-center gap-1">${badges.join('')}</div>`;
                cellText = null;
              }
            }
            cells.push({
              element: createCell({
                text: cellHtml ? null : cellText,
                html: cellHtml,
                numeric: value?.numeric || column.numeric || false,
                classes
              }),
              provider: provider.name
            });
          } else {
            classes.push(...providerSeverityClasses.muted);
            cells.push({
              element: createCell({
                text: '—',
                numeric: column.numeric || false,
                classes
              }),
              provider: provider.name
            });
          }
        });
      });

      cells.forEach((cell, index) => {
        cell.element.dataset.column = String(index);
        if (cell.provider) {
          cell.element.dataset.provider = cell.provider;
        }
        row.appendChild(cell.element);
      });

      return row;
    }

    function setupColumnHighlighting(table, providerColumnLookup = {}) {
      const highlightColumn = columnIndex => {
        table.querySelectorAll(`[data-column="${columnIndex}"]`).forEach(cell => {
          if (cell.tagName === 'TH') {
            cell.classList.add('column-highlight-header');
          } else {
            cell.classList.add('column-highlight');
          }
        });
      };

      const clearColumn = columnIndex => {
        table.querySelectorAll(`[data-column="${columnIndex}"]`).forEach(cell => {
          if (cell.tagName === 'TH') {
            cell.classList.remove('column-highlight-header');
          } else {
            cell.classList.remove('column-highlight');
          }
        });
      };

      table.querySelectorAll('[data-column]').forEach(cell => {
        if (cell.tagName === 'TD') {
          cell.tabIndex = 0;
        }
        const columnIndex = cell.dataset.column;
        cell.addEventListener('mouseenter', () => highlightColumn(columnIndex));
        cell.addEventListener('mouseleave', () => clearColumn(columnIndex));
        cell.addEventListener('focus', () => highlightColumn(columnIndex));
        cell.addEventListener('blur', () => clearColumn(columnIndex));
      });

      Object.entries(providerColumnLookup).forEach(([provider, columns]) => {
        const header = table.querySelector(`th[data-provider-group="${provider}"]`);
        if (!header) return;
        header.tabIndex = 0;
        const handleEnter = () => {
          header.classList.add('column-highlight-header');
          columns.forEach(highlightColumn);
        };
        const handleLeave = () => {
          header.classList.remove('column-highlight-header');
          columns.forEach(clearColumn);
        };
        header.addEventListener('mouseenter', handleEnter);
        header.addEventListener('mouseleave', handleLeave);
        header.addEventListener('focus', handleEnter);
        header.addEventListener('blur', handleLeave);
      });
    }

    async function loadChecks() {
      const loadingState = document.getElementById('loadingState');
      const errorState = document.getElementById('errorState');
      const errorMessage = document.getElementById('errorMessage');
      const tableContainer = document.getElementById('tableContainer');
      const table = document.getElementById('checks-table');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');

      loadingState.classList.remove('hidden');
      errorState.classList.add('hidden');
      tableContainer.classList.add('hidden');
      tbody.innerHTML = '';
      thead.innerHTML = '';

      try {
        const response = await fetch('checks.json', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        document.getElementById('timestamp').textContent = `Generated at ${new Date(data.generated_at).toLocaleString()}`;

        const providersMeta = data.providers || [];
        const { providerColumnLookup } = buildHeaders(thead, providersMeta);

        const totalColumns =
          BASE_COLUMNS.length +
          providersMeta.reduce((count, provider) => count + (provider.columns?.length || 0), 0);

        (data.models || []).forEach(model => {
          tbody.appendChild(buildModelRow(model, providersMeta));
        });

        const excluded = data.excluded_models || [];
        if (excluded.length) {
          const separator = document.createElement('tr');
          separator.className = 'bg-gray-50 dark:bg-gray-900/60 text-sm text-gray-600 dark:text-gray-300';
          const separatorCell = document.createElement('td');
          separatorCell.colSpan = totalColumns;
          separatorCell.className = 'px-6 py-3 font-semibold';
          separatorCell.textContent = 'Excluded models';
          separator.appendChild(separatorCell);
          tbody.appendChild(separator);

          excluded.forEach(entry => {
            const row = document.createElement('tr');
            row.className = 'text-sm text-gray-500 dark:text-gray-400';

            const idCell = document.createElement('td');
            idCell.className = 'px-6 py-4';
            idCell.textContent = entry.id;
            row.appendChild(idCell);

            const statusCell = document.createElement('td');
            statusCell.className = 'px-6 py-4';
            statusCell.appendChild(createBadge('excluded', 'missing'));
            row.appendChild(statusCell);

            const detailCell = document.createElement('td');
            detailCell.colSpan = totalColumns - 2;
            detailCell.className = 'px-6 py-4';
            detailCell.textContent = `${entry.owned_by || 'unknown'} (${entry.reason || 'config rule'})`;
            row.appendChild(detailCell);

            tbody.appendChild(row);
          });
        }

        loadingState.classList.add('hidden');
        tableContainer.classList.remove('hidden');
        setupColumnHighlighting(table, providerColumnLookup);
      } catch (error) {
        console.error('Failed to load checks:', error);
        errorMessage.textContent = `Failed to load pricing checks: ${error.message}`;
        loadingState.classList.add('hidden');
        errorState.classList.remove('hidden');
      }
    }

    loadChecks();
  </script>
</body>
</html>
