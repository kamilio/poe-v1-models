<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poe Models Changelog</title>
  <link rel="alternate" type="application/rss+xml" title="Poe Models Changelog RSS" href="changelog.xml">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#5D5CDE'
          }
        }
      }
    };
  </script>
</head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 transition-colors min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-3xl">
    <div class="mb-8">
      <div class="flex flex-wrap items-start justify-between gap-4">
        <div>
          <h1 class="text-3xl md:text-4xl font-bold mb-2">Poe Models Changelog</h1>
          <p class="text-gray-600 dark:text-gray-400">
            Latest updates to <a href="https://api.poe.com/v1/models" class="text-primary hover:opacity-80" target="_blank" rel="noopener">https://api.poe.com/v1/models</a>
          </p>
        </div>
        <a
          href="changelog.xml"
          class="inline-flex items-center gap-2 text-sm font-medium text-primary hover:opacity-80 transition-opacity"
        >
          <span class="inline-flex h-2 w-2 rounded-full bg-primary"></span>
          RSS feed
        </a>
      </div>
    </div>

    <div id="loadingState" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-300 border-t-primary"></div>
      <p class="mt-4 text-gray-600 dark:text-gray-400">Loading changelog...</p>
    </div>

    <div id="errorState" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6 text-center">
      <p class="text-red-800 dark:text-red-300" id="errorMessage"></p>
      <button
        onclick="loadChangelog()"
        class="mt-4 px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-all"
      >
        Retry
      </button>
    </div>

    <div id="changelogContainer" class="hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
        <ul id="changelogList" class="list-none divide-y divide-gray-200 dark:divide-gray-700">
        </ul>
      </div>
    </div>
  </div>

  <script>
    // NOTE: Update poe_v1_models.reporting.render_changelog_rss alongside any structural changes here.
    // Respect system dark mode preference
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      document.documentElement.classList.toggle('dark', event.matches);
    });

    function createBadge(text) {
      const badge = document.createElement('span');
      badge.className = 'inline-flex items-center rounded-full bg-primary/10 text-primary px-2.5 py-0.5 text-xs font-medium';
      badge.textContent = text;
      return badge;
    }

    function renderNames(items, options = {}) {
      const { codeClass = '' } = options;
      const fragment = document.createDocumentFragment();
      if (!Array.isArray(items) || !items.length) {
        const span = document.createElement('span');
        span.className = 'text-gray-500 dark:text-gray-400';
        span.textContent = 'none';
        fragment.appendChild(span);
        return fragment;
      }

      items.forEach((item, index) => {
        if (index) {
          fragment.appendChild(document.createTextNode(', '));
        }
        const code = document.createElement('code');
        code.className = `font-mono text-xs bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded ${codeClass}`.trim();
        code.textContent = item;
        fragment.appendChild(code);
      });
      return fragment;
    }

    function appendStatus(container, label, items, options = {}) {
      const { codeClass = '', textClass = 'text-gray-700 dark:text-gray-200' } = options;
      if (!Array.isArray(items) || items.length === 0) {
        return;
      }
      const wrapper = document.createElement('div');
      wrapper.className = `mt-3 text-sm ${textClass}`.trim();

      const heading = document.createElement('span');
      heading.className = 'font-semibold text-gray-900 dark:text-gray-100';
      heading.textContent = `${label}: `;
      wrapper.appendChild(heading);

      wrapper.appendChild(renderNames(items, { codeClass }));
      container.appendChild(wrapper);
    }

    function appendPriceChanges(container, priceChanges) {
      if (!Array.isArray(priceChanges) || priceChanges.length === 0) {
        return;
      }

      const wrapper = document.createElement('div');
      wrapper.className = 'mt-4 text-sm text-gray-700 dark:text-gray-200 space-y-3';

      const heading = document.createElement('div');
      heading.className = 'font-semibold text-gray-900 dark:text-gray-100';
      heading.textContent = 'Price changes';
      wrapper.appendChild(heading);

      priceChanges.forEach(change => {
        const block = document.createElement('div');

        const idRow = document.createElement('div');
        idRow.className = 'flex flex-wrap items-center gap-2';
        const idBadge = document.createElement('code');
        idBadge.className = 'font-mono text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-1.5 py-0.5 rounded';
        idBadge.textContent = change?.id ?? 'unknown-model';
        idRow.appendChild(idBadge);
        block.appendChild(idRow);

        const list = document.createElement('ul');
        list.className = 'mt-1 space-y-1';

        (change?.fields || []).forEach(field => {
          const item = document.createElement('li');
          item.className = 'flex flex-wrap items-baseline gap-2';

          const fieldLabel = document.createElement('span');
          fieldLabel.className = 'font-medium text-gray-900 dark:text-gray-100';
          fieldLabel.textContent = field?.field ?? 'pricing';
          item.appendChild(fieldLabel);

          const value = document.createElement('span');
          value.className = 'font-mono text-xs';
          const previous = field?.previous ?? '—';
          const current = field?.current ?? '—';
          let deltaText = '';
          if (field?.delta) {
            deltaText = field.delta.startsWith('-') ? field.delta : `+${field.delta}`;
            deltaText = ` (${deltaText})`;
          }
          value.textContent = `${previous} → ${current}${deltaText}`;

          if (field?.direction === 'decrease') {
            value.classList.add('text-green-600', 'dark:text-green-400');
          } else {
            value.classList.add('text-gray-900', 'dark:text-gray-100');
          }
          item.appendChild(value);

          if (field?.direction) {
            const direction = document.createElement('span');
            direction.className = 'text-[10px] uppercase tracking-wide text-gray-500 dark:text-gray-400';
            direction.textContent = field.direction;
            item.appendChild(direction);
          }

          list.appendChild(item);
        });

        block.appendChild(list);
        wrapper.appendChild(block);
      });

      container.appendChild(wrapper);
    }

    async function loadChangelog() {
      const loadingState = document.getElementById('loadingState');
      const errorState = document.getElementById('errorState');
      const errorMessage = document.getElementById('errorMessage');
      const changelogContainer = document.getElementById('changelogContainer');
      const list = document.getElementById('changelogList');

      loadingState.classList.remove('hidden');
      errorState.classList.add('hidden');
      changelogContainer.classList.add('hidden');
      list.innerHTML = '';

      try {
        const response = await fetch('changelog.json', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        const data = await response.json();
        const entries = Array.isArray(data) ? data.slice() : [];

        entries.sort((a, b) => {
          const aDate = Date.parse(a?.date || '');
          const bDate = Date.parse(b?.date || '');
          return (Number.isNaN(bDate) ? 0 : bDate) - (Number.isNaN(aDate) ? 0 : aDate);
        });

        if (!entries.length) {
          const empty = document.createElement('li');
          empty.className = 'px-6 py-6 text-sm text-gray-500 dark:text-gray-400';
          empty.textContent = 'No changelog entries yet.';
          list.appendChild(empty);
        } else {
          entries.forEach(entry => {
            const item = document.createElement('li');
            item.className = 'px-6 py-5';

            const header = document.createElement('div');
            header.className = 'flex flex-wrap items-center gap-2';

            const date = document.createElement('span');
            date.className = 'text-xs text-gray-500 dark:text-gray-400';
            if (entry.date) {
              date.textContent = new Date(entry.date).toLocaleString();
            } else {
              date.textContent = 'Date unavailable';
            }
            header.appendChild(date);

            if (entry.initial_snapshot) {
              header.appendChild(createBadge('initial snapshot'));
            }

            item.appendChild(header);

            appendStatus(item, 'Added', entry.added, {
              codeClass: 'text-green-600 dark:text-green-400',
              textClass: 'text-green-700/90 dark:text-green-300/90'
            });
            appendStatus(item, 'Removed', entry.removed, {
              codeClass: 'text-red-600 dark:text-red-400',
              textClass: 'text-red-700/90 dark:text-red-300/90'
            });
            appendPriceChanges(item, entry.price_changes);

            list.appendChild(item);
          });
        }

        loadingState.classList.add('hidden');
        changelogContainer.classList.remove('hidden');
      } catch (error) {
        console.error('Failed to load changelog:', error);
        errorMessage.textContent = 'Failed to load changelog: ' + error.message;
        loadingState.classList.add('hidden');
        errorState.classList.remove('hidden');
      }
    }

    loadChangelog();
  </script>
</body>
</html>
