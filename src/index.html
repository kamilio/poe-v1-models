<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Model Pricing Table</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#5D5CDE'
          }
        }
      }
    };
  </script>
  <style>
    @media (max-width: 768px) {
      .table-container {
        overflow-x: auto;
      }
      table {
        min-width: 800px;
      }
    }
  </style>
</head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 transition-colors min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <div class="mb-8">
      <h1 class="text-3xl md:text-4xl font-bold mb-2">Model Pricing</h1>
      <p class="text-gray-600 dark:text-gray-400">Compare pricing across all available models</p>
      <a
        href="changelog.html"
        class="mt-3 inline-flex items-center gap-2 text-primary hover:text-primary/90 font-medium"
      >
        View changelog
        <span aria-hidden="true">→</span>
      </a>
    </div>

    <div class="mb-6 flex flex-col sm:flex-row gap-4">
      <input
        type="text"
        id="searchInput"
        placeholder="Search models..."
        class="flex-1 px-4 py-2 text-base border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-primary transition-all"
      >
      <select
        id="filterModality"
        class="px-4 py-2 text-base border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-primary transition-all"
      >
        <option value="">All Output Modalities</option>
      </select>
    </div>

    <div id="loadingState" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-300 border-t-primary"></div>
      <p class="mt-4 text-gray-600 dark:text-gray-400">Loading pricing data...</p>
    </div>

    <div id="errorState" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6 text-center">
      <p class="text-red-800 dark:text-red-300" id="errorMessage"></p>
      <button
        onclick="loadData()"
        class="mt-4 px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-all"
      >
        Retry
      </button>
    </div>

    <div class="table-container hidden" id="tableContainer">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden border border-gray-200 dark:border-gray-700">
        <table class="w-full">
          <thead>
            <tr class="bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700">
              <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" onclick="sortTable('name')">
                Model Name
                <span class="ml-1 text-gray-400">↕</span>
              </th>
              <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 dark:text-gray-100 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" onclick="sortTable('owner')">
                Provider
                <span class="ml-1 text-gray-400">↕</span>
              </th>
              <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">
                Input
              </th>
              <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900 dark:text-gray-100">
                Output
              </th>
              <th class="px-6 py-4 text-right text-sm font-semibold text-gray-900 dark:text-gray-100 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" onclick="sortTable('prompt')">
                Prompt
                <span class="ml-1 text-gray-400">↕</span>
                <div class="text-xs font-normal text-gray-500 dark:text-gray-400">per 1M tokens</div>
              </th>
              <th class="px-6 py-4 text-right text-sm font-semibold text-gray-900 dark:text-gray-100 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" onclick="sortTable('completion')">
                Completion
                <span class="ml-1 text-gray-400">↕</span>
                <div class="text-xs font-normal text-gray-500 dark:text-gray-400">per 1M tokens</div>
              </th>
              <th class="px-6 py-4 text-right text-sm font-semibold text-gray-900 dark:text-gray-100 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" onclick="sortTable('input_cache_read')">
                Cache Read
                <span class="ml-1 text-gray-400">↕</span>
                <div class="text-xs font-normal text-gray-500 dark:text-gray-400">per 1M tokens</div>
              </th>
              <th class="px-6 py-4 text-right text-sm font-semibold text-gray-900 dark:text-gray-100 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" onclick="sortTable('input_cache_write')">
                Cache Write
                <span class="ml-1 text-gray-400">↕</span>
                <div class="text-xs font-normal text-gray-500 dark:text-gray-400">per 1M tokens</div>
              </th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
        </table>
      </div>

      <div class="mt-6 text-sm text-gray-600 dark:text-gray-400 text-center">
        Showing <span id="visibleCount" class="font-semibold text-gray-900 dark:text-gray-100">0</span> of
        <span id="totalCount" class="font-semibold text-gray-900 dark:text-gray-100">0</span> models
      </div>
    </div>
  </div>

  <script>
    // Respect system dark mode preference
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      document.documentElement.classList.toggle('dark', event.matches);
    });

    const DATA_URL = 'models.json';
    let allModels = [];
    let filteredModels = [];
    let sortConfig = { key: null, direction: 'asc' };
    let fuse = null;

    function parseNumeric(value) {
      if (value === undefined || value === null || value === '' || value === 'null') return null;
      const numberValue = Number(value);
      return Number.isFinite(numberValue) ? numberValue : null;
    }

    // Convert pricing payload into per-million token numbers that are easy to compare.
    function getPricingPair(pricing, field) {
      if (!pricing) return { price: null, msrp: null };
      const perMillion = parseNumeric(pricing[`${field}_mtok`]);
      const perToken = parseNumeric(pricing[field]);
      const msrpPerMillion = parseNumeric(pricing[`msrp_${field}_mtok`]);
      const msrpPerToken = parseNumeric(pricing[`msrp_${field}`]);

      const price = perMillion !== null ? perMillion : perToken !== null ? perToken * 1_000_000 : null;
      const msrp = msrpPerMillion !== null ? msrpPerMillion : msrpPerToken !== null ? msrpPerToken * 1_000_000 : null;

      return { price, msrp };
    }

    function formatCurrency(value) {
      if (value === null) return 'N/A';
      const options = value >= 100 ? { maximumFractionDigits: 0 } : { minimumFractionDigits: 2, maximumFractionDigits: 2 };
      return '$' + value.toLocaleString(undefined, options);
    }

    function formatPriceWithMSRP(pricing, field) {
      const { price, msrp } = getPricingPair(pricing, field);
      if (price === null) {
        return '<span class=\"text-gray-500 dark:text-gray-400\">N/A</span>';
      }

      const priceLabel = formatCurrency(price);
      if (msrp !== null && msrp > price) {
        const savings = Math.round(((msrp - price) / msrp) * 100);
        return `
          <div class=\"flex flex-col items-end gap-0.5\">
            <div class=\"text-xs text-gray-500 dark:text-gray-400 line-through\">${formatCurrency(msrp)}</div>
            <div class=\"text-gray-900 dark:text-gray-100 font-semibold\">${priceLabel}</div>
            <div class=\"text-xs text-red-600 dark:text-red-400 font-medium\">Save ${savings}%</div>
          </div>
        `;
      }

      return `<span class=\"text-gray-900 dark:text-gray-100 font-semibold\">${priceLabel}</span>`;
    }

    function formatModalities(modalities) {
      if (!modalities || modalities.length === 0) return 'N/A';
      return modalities.map(modality => (
        '<span class=\"inline-block px-2 py-1 text-xs rounded bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300\">' +
        modality +
        '</span>'
      )).join(' ');
    }

    function renderTable(models) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      if (models.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan=\"8\" class=\"px-6 py-12 text-center text-gray-500 dark:text-gray-400\">
              No models found matching your criteria
            </td>
          </tr>
        `;
        document.getElementById('visibleCount').textContent = '0';
        document.getElementById('totalCount').textContent = allModels.length;
        return;
      }

      const fragment = document.createDocumentFragment();
      models.forEach(model => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors';
        row.innerHTML = `
          <td class=\"px-6 py-4\">
            <a href=\"https://poe.com/${model.id}\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"font-medium text-primary hover:text-primary/80 hover:underline transition-all\">
              ${model.id}
            </a>
          </td>
          <td class=\"px-6 py-4\">
            <span class=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary/10 text-primary\">
              ${model.owned_by}
            </span>
          </td>
          <td class=\"px-6 py-4\">
            <div class=\"flex flex-wrap gap-1\">
              ${formatModalities(model.architecture?.input_modalities)}
            </div>
          </td>
          <td class=\"px-6 py-4\">
            <div class=\"flex flex-wrap gap-1\">
              ${formatModalities(model.architecture?.output_modalities)}
            </div>
          </td>
          <td class=\"px-6 py-4 text-right font-mono text-sm\">
            ${formatPriceWithMSRP(model.pricing, 'prompt')}
          </td>
          <td class=\"px-6 py-4 text-right font-mono text-sm\">
            ${formatPriceWithMSRP(model.pricing, 'completion')}
          </td>
          <td class=\"px-6 py-4 text-right font-mono text-sm\">
            ${formatPriceWithMSRP(model.pricing, 'input_cache_read')}
          </td>
          <td class=\"px-6 py-4 text-right font-mono text-sm\">
            ${formatPriceWithMSRP(model.pricing, 'input_cache_write')}
          </td>
        `;
        fragment.appendChild(row);
      });

      tbody.appendChild(fragment);
      document.getElementById('visibleCount').textContent = models.length;
      document.getElementById('totalCount').textContent = allModels.length;
    }

    function numericSort(aVal, bVal, direction) {
      if (aVal === null && bVal === null) return 0;
      if (aVal === null) return 1;
      if (bVal === null) return -1;
      if (aVal < bVal) return direction === 'asc' ? -1 : 1;
      if (aVal > bVal) return direction === 'asc' ? 1 : -1;
      return 0;
    }

    function sortTable(key) {
      if (sortConfig.key === key) {
        sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
      } else {
        sortConfig.key = key;
        sortConfig.direction = 'asc';
      }

      filteredModels.sort((a, b) => {
        switch (key) {
          case 'name': {
            const aVal = a.id.toLowerCase();
            const bVal = b.id.toLowerCase();
            if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
            return 0;
          }
          case 'owner': {
            const aVal = a.owned_by.toLowerCase();
            const bVal = b.owned_by.toLowerCase();
            if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
            return 0;
          }
          case 'prompt': {
            const aVal = getPricingPair(a.pricing, 'prompt').price;
            const bVal = getPricingPair(b.pricing, 'prompt').price;
            return numericSort(aVal, bVal, sortConfig.direction);
          }
          case 'completion': {
            const aVal = getPricingPair(a.pricing, 'completion').price;
            const bVal = getPricingPair(b.pricing, 'completion').price;
            return numericSort(aVal, bVal, sortConfig.direction);
          }
          case 'input_cache_read': {
            const aVal = getPricingPair(a.pricing, 'input_cache_read').price;
            const bVal = getPricingPair(b.pricing, 'input_cache_read').price;
            return numericSort(aVal, bVal, sortConfig.direction);
          }
          case 'input_cache_write': {
            const aVal = getPricingPair(a.pricing, 'input_cache_write').price;
            const bVal = getPricingPair(b.pricing, 'input_cache_write').price;
            return numericSort(aVal, bVal, sortConfig.direction);
          }
          default:
            return 0;
        }
      });

      renderTable(filteredModels);
    }

    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.trim();
      const modalityFilter = document.getElementById('filterModality').value;

      let results = allModels;

      if (searchTerm && fuse) {
        results = fuse.search(searchTerm).map(entry => entry.item);
      }

      if (modalityFilter) {
        results = results.filter(model => {
          const outputs = model.architecture?.output_modalities;
          if (!Array.isArray(outputs)) return false;
          return outputs.includes(modalityFilter);
        });
      }

      filteredModels = results;
      renderTable(filteredModels);
    }

    function populateModalityFilter() {
      const select = document.getElementById('filterModality');
      // Retain the default option
      select.length = 1;
      const modalities = new Set();
      allModels.forEach(model => {
        const outputs = model.architecture?.output_modalities;
        if (Array.isArray(outputs)) {
          outputs.forEach(modality => modalities.add(modality));
        }
      });
      Array.from(modalities)
        .sort((a, b) => a.localeCompare(b))
        .forEach(modality => {
          const option = document.createElement('option');
          option.value = modality;
          option.textContent = modality;
          select.appendChild(option);
        });
    }

    async function loadData() {
      const loadingState = document.getElementById('loadingState');
      const errorState = document.getElementById('errorState');
      const tableContainer = document.getElementById('tableContainer');

      loadingState.classList.remove('hidden');
      errorState.classList.add('hidden');
      tableContainer.classList.add('hidden');

      try {
        const response = await fetch(DATA_URL, { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const payload = await response.json();
        allModels = payload.data || [];
        filteredModels = [...allModels];

        fuse = new Fuse(allModels, {
          keys: ['id', 'owned_by', 'architecture.output_modalities'],
          threshold: 0.3,
          includeScore: true,
          minMatchCharLength: 2
        });

        populateModalityFilter();
        renderTable(filteredModels);

        loadingState.classList.add('hidden');
        tableContainer.classList.remove('hidden');
      } catch (error) {
        console.error('Error loading data:', error);
        loadingState.classList.add('hidden');
        errorState.classList.remove('hidden');
        document.getElementById('errorMessage').textContent = 'Failed to load pricing data: ' + error.message;
      }
    }

    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('filterModality').addEventListener('change', applyFilters);
    loadData();
  </script>
</body>
</html>
